{% extends "base-ultimate.html" %}

{% block title %}Competitive Intelligence - BD Intelligence{% endblock %}
{% block page_title %}Competitive Intelligence{% endblock %}
{% block page_subtitle %}Analyze incumbents, identify teaming partners, and track market trends{% endblock %}

{% block stats_bar %}
<div class="stats-bar">
    <div class="stat-item">
        <div class="stat-icon blue">
            <i class="fas fa-file-contract"></i>
        </div>
        <div class="stat-info">
            <h4 id="total-contracts">0</h4>
            <p>Contracts Tracked</p>
        </div>
    </div>
    
    <div class="stat-item">
        <div class="stat-icon green">
            <i class="fas fa-building"></i>
        </div>
        <div class="stat-info">
            <h4 id="total-contractors">0</h4>
            <p>Contractors</p>
        </div>
    </div>
    
    <div class="stat-item">
        <div class="stat-icon purple">
            <i class="fas fa-landmark"></i>
        </div>
        <div class="stat-info">
            <h4 id="total-agencies">0</h4>
            <p>Agencies</p>
        </div>
    </div>
    
    <div class="stat-item">
        <div class="stat-icon orange">
            <i class="fas fa-dollar-sign"></i>
        </div>
        <div class="stat-info">
            <h4 id="total-value">$0</h4>
            <p>Total Contract Value</p>
        </div>
    </div>
</div>
{% endblock %}

{% block top_actions %}
<button class="btn btn-primary" onclick="refreshData()">
    <i class="fas fa-sync me-2"></i>Refresh Data
</button>

<div class="btn-group">
    <button class="btn btn-outline-primary active" id="view-incumbents" onclick="setView('incumbents')">
        <i class="fas fa-building me-1"></i>Incumbents
    </button>
    <button class="btn btn-outline-primary" id="view-partners" onclick="setView('partners')">
        <i class="fas fa-handshake me-1"></i>Teaming Partners
    </button>
    <button class="btn btn-outline-primary" id="view-trends" onclick="setView('trends')">
        <i class="fas fa-chart-line me-1"></i>Market Trends
    </button>
</div>
{% endblock %}

{% block content %}
<!-- Incumbents View -->
<div id="incumbents-view">
    <div class="row">
        <div class="col-12 mb-3">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-filter me-2"></i>Filter Incumbents</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <label class="form-label small">Agency</label>
                            <select class="form-select form-select-sm" id="filter-agency" onchange="filterIncumbents()">
                                <option value="">All Agencies</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">NAICS Code</label>
                            <select class="form-select form-select-sm" id="filter-naics" onchange="filterIncumbents()">
                                <option value="">All NAICS</option>
                                <option value="541511">541511 - Custom Computer Programming</option>
                                <option value="541512">541512 - Computer Systems Design</option>
                                <option value="541519">541519 - Other Computer Services</option>
                                <option value="518210">518210 - Data Processing</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">Min Contract Value</label>
                            <input type="number" class="form-control form-control-sm" id="filter-min-value" 
                                   placeholder="e.g., 100000" onchange="filterIncumbents()">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">Search Contractor</label>
                            <input type="text" class="form-control form-control-sm" id="filter-search" 
                                   placeholder="Search by name..." onkeyup="filterIncumbents()">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-trophy me-2"></i>Top Incumbents</h6>
                </div>
                <div class="card-body">
                    <div id="incumbents-table">
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-spinner fa-spin fa-3x mb-3"></i>
                            <p>Loading contract data...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Teaming Partners View -->
<div id="partners-view" style="display: none;">
    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-crosshairs me-2"></i>Similar NAICS Codes</h6>
                </div>
                <div class="card-body">
                    <p class="small text-muted mb-3">Contractors winning work in the same NAICS codes as your target opportunities</p>
                    <div id="partners-naics"></div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-landmark me-2"></i>Same Agencies</h6>
                </div>
                <div class="card-body">
                    <p class="small text-muted mb-3">Contractors with recent awards from your target agencies</p>
                    <div id="partners-agencies"></div>
                </div>
            </div>
        </div>
        
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-handshake me-2"></i>Recommended Partners</h6>
                </div>
                <div class="card-body">
                    <p class="small text-muted mb-3">Contractors with complementary capabilities and no direct competition</p>
                    <div id="partners-recommended"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Market Trends View -->
<div id="trends-view" style="display: none;">
    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-chart-area me-2"></i>Contract Awards Over Time</h6>
                </div>
                <div class="card-body">
                    <canvas id="trends-timeline" height="250"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Market Share by Contractor</h6>
                </div>
                <div class="card-body">
                    <canvas id="trends-marketshare" height="250"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-landmark me-2"></i>Top Agencies by Contract Value</h6>
                </div>
                <div class="card-body">
                    <div id="trends-agencies"></div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-code-branch me-2"></i>NAICS Distribution</h6>
                </div>
                <div class="card-body">
                    <canvas id="trends-naics" height="250"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
let currentView = 'incumbents';
let allIncumbents = [];
let allPartners = [];
let marketData = {};

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    loadStats();
    loadIncumbents();
    loadFilterOptions();
});

async function loadStats() {
    try {
        const res = await fetch('/api/competitive/stats');
        const data = await res.json();
        
        document.getElementById('total-contracts').textContent = (data.contract_count || 0).toLocaleString();
        document.getElementById('total-contractors').textContent = (data.contractor_count || 0).toLocaleString();
        document.getElementById('total-agencies').textContent = (data.agency_count || 0).toLocaleString();
        
        const totalValue = data.total_value || 0;
        document.getElementById('total-value').textContent = formatCurrency(totalValue);
    } catch (err) {
        console.error('Error loading stats:', err);
    }
}

async function loadIncumbents() {
    try {
        const res = await fetch('/api/competitive/incumbents');
        const data = await res.json();
        
        allIncumbents = data.incumbents || [];
        renderIncumbents(allIncumbents);
    } catch (err) {
        console.error('Error loading incumbents:', err);
        document.getElementById('incumbents-table').innerHTML = `
            <div class="text-center text-muted py-5">
                <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                <p>Error loading contract data. Make sure Neo4j is running and contracts are loaded.</p>
            </div>
        `;
    }
}

async function loadFilterOptions() {
    try {
        const res = await fetch('/api/competitive/filter-options');
        const data = await res.json();
        
        const agencySelect = document.getElementById('filter-agency');
        (data.agencies || []).forEach(agency => {
            const opt = document.createElement('option');
            opt.value = agency;
            opt.textContent = agency;
            agencySelect.appendChild(opt);
        });
    } catch (err) {
        console.error('Error loading filter options:', err);
    }
}

function renderIncumbents(incumbents) {
    const container = document.getElementById('incumbents-table');
    
    if (incumbents.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-5">
                <i class="fas fa-inbox fa-3x mb-3"></i>
                <p>No contracts found matching your filters.</p>
            </div>
        `;
        return;
    }
    
    let html = '<div class="table-responsive"><table class="table table-hover">';
    html += `<thead>
        <tr>
            <th>Rank</th>
            <th>Contractor</th>
            <th>Contracts</th>
            <th>Total Value</th>
            <th>Avg Value</th>
            <th>Top Agency</th>
            <th>Recent NAICS</th>
        </tr>
    </thead><tbody>`;
    
    incumbents.forEach((inc, idx) => {
        html += `<tr>
            <td><span class="badge bg-${idx < 3 ? 'warning' : 'secondary'}">#${idx + 1}</span></td>
            <td>
                <a href="/competitive-intel/contractor/${encodeURIComponent(inc.contractor)}" 
                   class="text-white text-decoration-none" 
                   style="cursor: pointer;"
                   onmouseover="this.style.color='#667eea'" 
                   onmouseout="this.style.color='white'">
                    <strong>${inc.contractor}</strong>
                </a>
            </td>
            <td>${inc.contract_count}</td>
            <td>${formatCurrency(inc.total_value)}</td>
            <td>${formatCurrency(inc.avg_value)}</td>
            <td><small class="text-muted">${inc.top_agency || 'N/A'}</small></td>
            <td><small class="text-muted">${inc.naics_codes ? inc.naics_codes.slice(0, 3).join(', ') : 'N/A'}</small></td>
        </tr>`;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

function filterIncumbents() {
    const agency = document.getElementById('filter-agency').value;
    const naics = document.getElementById('filter-naics').value;
    const minValue = parseFloat(document.getElementById('filter-min-value').value) || 0;
    const search = document.getElementById('filter-search').value.toLowerCase();
    
    const filtered = allIncumbents.filter(inc => {
        if (agency && inc.top_agency !== agency) return false;
        if (naics && (!inc.naics_codes || !inc.naics_codes.includes(naics))) return false;
        if (minValue > 0 && inc.total_value < minValue) return false;
        if (search && !inc.contractor.toLowerCase().includes(search)) return false;
        return true;
    });
    
    renderIncumbents(filtered);
}

function setView(view) {
    currentView = view;
    
    document.getElementById('incumbents-view').style.display = view === 'incumbents' ? 'block' : 'none';
    document.getElementById('partners-view').style.display = view === 'partners' ? 'block' : 'none';
    document.getElementById('trends-view').style.display = view === 'trends' ? 'block' : 'none';
    
    document.getElementById('view-incumbents').classList.toggle('active', view === 'incumbents');
    document.getElementById('view-partners').classList.toggle('active', view === 'partners');
    document.getElementById('view-trends').classList.toggle('active', view === 'trends');
    
    if (view === 'partners' && allPartners.length === 0) {
        loadPartners();
    }
    if (view === 'trends' && !marketData.timeline) {
        loadMarketTrends();
    }
}

async function loadPartners() {
    try {
        const res = await fetch('/api/competitive/teaming-partners');
        const data = await res.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        allPartners = data;
        
        // Render partners by NAICS
        renderPartnersByNaics(data.by_naics || []);
        
        // Render partners by Agency
        renderPartnersByAgency(data.by_agency || []);
        
        // Render recommended partners
        renderRecommendedPartners(data.recommended || []);
        
    } catch (err) {
        console.error('Error loading partners:', err);
        document.getElementById('partners-naics').innerHTML = `
            <div class="alert alert-danger">Error loading teaming partners: ${err.message}</div>
        `;
    }
}

function renderPartnersByNaics(byNaics) {
    const container = document.getElementById('partners-naics');
    
    if (!byNaics.length) {
        container.innerHTML = '<p class="text-muted">No NAICS data available</p>';
        return;
    }
    
    let html = '<div class="accordion" id="naicsAccordion">';
    byNaics.forEach((item, idx) => {
        const naicsName = {
            '541512': 'Computer Systems Design',
            '541511': 'Custom Computer Programming',
            '541519': 'Other Computer Services',
            '518210': 'Data Processing'
        }[item.naics] || item.naics;
        
        html += `
            <div class="accordion-item" style="background: var(--surface); border-color: var(--border);">
                <h2 class="accordion-header">
                    <button class="accordion-button ${idx > 0 ? 'collapsed' : ''}" type="button" 
                            data-bs-toggle="collapse" data-bs-target="#naics-${idx}"
                            style="background: var(--surface-light); color: var(--text);">
                        <span class="badge bg-primary me-2">${item.naics}</span>
                        ${naicsName} 
                        <span class="badge bg-secondary ms-2">${item.contractors.length} contractors</span>
                    </button>
                </h2>
                <div id="naics-${idx}" class="accordion-collapse collapse ${idx === 0 ? 'show' : ''}" 
                     data-bs-parent="#naicsAccordion">
                    <div class="accordion-body">
                        <table class="table table-sm table-hover">
                            <thead><tr><th>Contractor</th><th>Contracts</th><th>Value</th><th style="width:80px;">Actions</th></tr></thead>
                            <tbody>
                                ${item.contractors.map(c => `
                                    <tr>
                                        <td class="contractor-row" onclick="showContractorDetails('${c.contractor.replace(/'/g, "\\'")}')">
                                            <i class="fas fa-building me-2 text-muted"></i>${c.contractor}
                                        </td>
                                        <td>${c.contract_count}</td>
                                        <td>${formatCurrency(c.total_value)}</td>
                                        <td>
                                            <button class="btn btn-sm org-research-btn" 
                                                onclick="event.stopPropagation(); viewOrgResearch('${c.contractor.replace(/'/g, "\\'")}')"
                                                title="Research this contractor">
                                                <i class="fas fa-brain"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    container.innerHTML = html;
}

function renderPartnersByAgency(byAgency) {
    const container = document.getElementById('partners-agencies');
    
    if (!byAgency.length) {
        container.innerHTML = '<p class="text-muted">No agency data available</p>';
        return;
    }
    
    let html = '<div class="accordion" id="agencyAccordion">';
    byAgency.forEach((item, idx) => {
        html += `
            <div class="accordion-item" style="background: var(--surface); border-color: var(--border);">
                <h2 class="accordion-header">
                    <button class="accordion-button ${idx > 0 ? 'collapsed' : ''}" type="button"
                            data-bs-toggle="collapse" data-bs-target="#agency-${idx}"
                            style="background: var(--surface-light); color: var(--text);">
                        <i class="fas fa-landmark me-2"></i>
                        ${item.agency ? item.agency.substring(0, 50) : 'Unknown'}${item.agency && item.agency.length > 50 ? '...' : ''}
                        <span class="badge bg-secondary ms-2">${item.contractors.length} contractors</span>
                    </button>
                </h2>
                <div id="agency-${idx}" class="accordion-collapse collapse ${idx === 0 ? 'show' : ''}"
                     data-bs-parent="#agencyAccordion">
                    <div class="accordion-body">
                        <table class="table table-sm table-hover">
                            <thead><tr><th>Contractor</th><th>Contracts</th><th>Value</th><th style="width:80px;">Actions</th></tr></thead>
                            <tbody>
                                ${item.contractors.map(c => `
                                    <tr>
                                        <td class="contractor-row" onclick="showContractorDetails('${c.contractor.replace(/'/g, "\\'")}')">
                                            <i class="fas fa-building me-2 text-muted"></i>${c.contractor}
                                        </td>
                                        <td>${c.contract_count}</td>
                                        <td>${formatCurrency(c.total_value)}</td>
                                        <td>
                                            <button class="btn btn-sm org-research-btn" 
                                                onclick="event.stopPropagation(); viewOrgResearch('${c.contractor.replace(/'/g, "\\'")}')"
                                                title="Research this contractor">
                                                <i class="fas fa-brain"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    container.innerHTML = html;
}

function renderRecommendedPartners(recommended) {
    const container = document.getElementById('partners-recommended');
    
    if (!recommended.length) {
        container.innerHTML = '<p class="text-muted">No recommendations available</p>';
        return;
    }
    
    let html = '<div class="table-responsive"><table class="table table-hover">';
    html += `<thead>
        <tr>
            <th>Contractor</th>
            <th>Contracts</th>
            <th>Total Value</th>
            <th>Agency Reach</th>
            <th>NAICS Coverage</th>
            <th>Partner Score</th>
            <th style="width:80px;">Research</th>
        </tr>
    </thead><tbody>`;
    
    recommended.forEach(p => {
        const scoreClass = p.partner_score > 10 ? 'success' : p.partner_score > 5 ? 'warning' : 'secondary';
        html += `<tr>
            <td class="contractor-cell" onclick="showContractorDetails('${p.contractor.replace(/'/g, "\\'")}')">
                <i class="fas fa-building me-2 text-muted"></i><strong>${p.contractor}</strong>
                <br><small class="text-muted">${(p.top_agencies || []).slice(0, 2).join(', ')}</small>
            </td>
            <td>${p.contract_count}</td>
            <td>${formatCurrency(p.total_value)}</td>
            <td><span class="badge bg-info">${p.agency_diversity} agencies</span></td>
            <td><span class="badge bg-primary">${p.naics_diversity} NAICS</span></td>
            <td><span class="badge bg-${scoreClass}">${p.partner_score}</span></td>
            <td>
                <button class="btn btn-sm org-research-btn" 
                    onclick="event.stopPropagation(); viewOrgResearch('${p.contractor.replace(/'/g, "\\'")}')"
                    title="Research this contractor">
                    <i class="fas fa-brain"></i>
                </button>
            </td>
        </tr>`;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

async function loadMarketTrends() {
    try {
        const res = await fetch('/api/competitive/market-trends');
        const data = await res.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        marketData = data;
        
        // Render timeline chart
        renderTimelineChart(data.timeline || []);
        
        // Render market share chart
        renderMarketShareChart(data.market_share || []);
        
        // Render top agencies
        renderTopAgencies(data.top_agencies || []);
        
        // Render NAICS distribution chart
        renderNaicsChart(data.naics_distribution || []);
        
    } catch (err) {
        console.error('Error loading market trends:', err);
        document.getElementById('trends-agencies').innerHTML = `
            <div class="alert alert-danger">Error loading market trends: ${err.message}</div>
        `;
    }
}

let timelineChart = null;
let marketShareChart = null;
let naicsChart = null;

function renderTimelineChart(timeline) {
    const ctx = document.getElementById('trends-timeline');
    if (!ctx) return;
    
    if (timelineChart) timelineChart.destroy();
    
    if (!timeline.length) {
        ctx.parentElement.innerHTML = '<p class="text-muted text-center py-5">No timeline data available</p>';
        return;
    }
    
    timelineChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: timeline.map(t => t.month),
            datasets: [{
                label: 'Contract Value ($M)',
                data: timeline.map(t => (t.total_value || 0) / 1000000),
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                fill: true,
                tension: 0.4
            }, {
                label: 'Contract Count',
                data: timeline.map(t => t.contract_count),
                borderColor: '#00C896',
                backgroundColor: 'transparent',
                yAxisID: 'y1',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { labels: { color: '#E6EDF3' } }
            },
            scales: {
                x: { ticks: { color: '#8B949E' }, grid: { color: '#30363D' } },
                y: { 
                    ticks: { color: '#8B949E', callback: v => '$' + v + 'M' }, 
                    grid: { color: '#30363D' },
                    title: { display: true, text: 'Value ($M)', color: '#8B949E' }
                },
                y1: {
                    position: 'right',
                    ticks: { color: '#8B949E' },
                    grid: { display: false },
                    title: { display: true, text: 'Count', color: '#8B949E' }
                }
            }
        }
    });
}

function renderMarketShareChart(marketShare) {
    const ctx = document.getElementById('trends-marketshare');
    if (!ctx) return;
    
    if (marketShareChart) marketShareChart.destroy();
    
    if (!marketShare.length) {
        ctx.parentElement.innerHTML = '<p class="text-muted text-center py-5">No market share data available</p>';
        return;
    }
    
    const colors = [
        '#667eea', '#00C896', '#FFB020', '#FF4757', '#00D4FF',
        '#9C27B0', '#FF9800', '#4CAF50', '#2196F3', '#E91E63'
    ];
    
    marketShareChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: marketShare.map(m => m.contractor.substring(0, 20) + (m.contractor.length > 20 ? '...' : '')),
            datasets: [{
                data: marketShare.map(m => m.total_value),
                backgroundColor: colors,
                borderColor: '#161B22',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { 
                    position: 'right',
                    labels: { 
                        color: '#E6EDF3',
                        font: { size: 10 },
                        boxWidth: 12
                    }
                },
                tooltip: {
                    callbacks: {
                        label: ctx => `${ctx.label}: ${formatCurrency(ctx.raw)}`
                    }
                }
            }
        }
    });
}

function renderTopAgencies(agencies) {
    const container = document.getElementById('trends-agencies');
    
    if (!agencies.length) {
        container.innerHTML = '<p class="text-muted">No agency data available</p>';
        return;
    }
    
    const maxValue = Math.max(...agencies.map(a => a.total_value));
    
    let html = '<div class="list-group list-group-flush">';
    agencies.forEach((agency, idx) => {
        const pct = ((agency.total_value / maxValue) * 100).toFixed(0);
        html += `
            <div class="list-group-item" style="background: transparent; border-color: var(--border);">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <span class="small">
                        <span class="badge bg-${idx < 3 ? 'warning' : 'secondary'} me-2">#${idx + 1}</span>
                        ${agency.agency ? agency.agency.substring(0, 40) : 'Unknown'}${agency.agency && agency.agency.length > 40 ? '...' : ''}
                    </span>
                    <span class="small text-muted">${formatCurrency(agency.total_value)}</span>
                </div>
                <div class="progress" style="height: 6px; background: var(--surface-light);">
                    <div class="progress-bar" role="progressbar" style="width: ${pct}%; background: linear-gradient(90deg, #667eea, #00D4FF);"></div>
                </div>
                <small class="text-muted">${agency.contract_count} contracts</small>
            </div>
        `;
    });
    html += '</div>';
    container.innerHTML = html;
}

function renderNaicsChart(naicsData) {
    const ctx = document.getElementById('trends-naics');
    if (!ctx) return;
    
    if (naicsChart) naicsChart.destroy();
    
    if (!naicsData.length) {
        ctx.parentElement.innerHTML = '<p class="text-muted text-center py-5">No NAICS data available</p>';
        return;
    }
    
    const naicsNames = {
        '541512': 'Sys Design',
        '541511': 'Programming',
        '541519': 'Other IT',
        '518210': 'Data Proc'
    };
    
    naicsChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: naicsData.map(n => naicsNames[n.naics] || n.naics),
            datasets: [{
                label: 'Contract Value ($M)',
                data: naicsData.map(n => (n.total_value || 0) / 1000000),
                backgroundColor: '#667eea',
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            indexAxis: 'y',
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: { 
                    ticks: { color: '#8B949E', callback: v => '$' + v + 'M' }, 
                    grid: { color: '#30363D' }
                },
                y: { 
                    ticks: { color: '#8B949E' }, 
                    grid: { display: false }
                }
            }
        }
    });
}

function refreshData() {
    loadStats();
    loadIncumbents();
    if (currentView === 'partners') loadPartners();
    if (currentView === 'trends') loadMarketTrends();
}

function formatCurrency(value) {
    if (!value) return '$0';
    if (value >= 1000000) return '$' + (value / 1000000).toFixed(1) + 'M';
    if (value >= 1000) return '$' + (value / 1000).toFixed(0) + 'K';
    return '$' + value.toLocaleString();
}

// Contractor Details Modal
async function showContractorDetails(contractorName) {
    const modal = new bootstrap.Modal(document.getElementById('contractorModal'));
    document.getElementById('contractor-modal-name').textContent = contractorName;
    document.getElementById('contractor-loading').style.display = 'block';
    document.getElementById('contractor-content').style.display = 'none';
    
    modal.show();
    
    try {
        const res = await fetch(`/api/competitive/contractor-details?name=${encodeURIComponent(contractorName)}`);
        const data = await res.json();
        
        document.getElementById('contractor-loading').style.display = 'none';
        document.getElementById('contractor-content').style.display = 'block';
        
        if (data.error) {
            document.getElementById('contractor-content').innerHTML = `
                <div class="alert alert-danger">${data.error}</div>
            `;
            return;
        }
        
        // Summary stats
        document.getElementById('contractor-total-contracts').textContent = data.contract_count || 0;
        document.getElementById('contractor-total-value').textContent = formatCurrency(data.total_value);
        document.getElementById('contractor-agencies-count').textContent = (data.agencies || []).length;
        document.getElementById('contractor-naics-count').textContent = (data.naics_codes || []).length;
        
        // Agencies list
        const agenciesHtml = (data.agencies || []).map(a => `
            <span class="badge bg-primary me-1 mb-1">${a}</span>
        `).join('') || '<span class="text-muted">No agencies found</span>';
        document.getElementById('contractor-agencies').innerHTML = agenciesHtml;
        
        // NAICS list
        const naicsNames = {
            '541512': 'Computer Systems Design',
            '541511': 'Custom Programming',
            '541519': 'Other IT Services',
            '518210': 'Data Processing'
        };
        const naicsHtml = (data.naics_codes || []).map(n => `
            <span class="badge bg-info me-1 mb-1" title="${naicsNames[n] || n}">${n}</span>
        `).join('') || '<span class="text-muted">No NAICS codes found</span>';
        document.getElementById('contractor-naics').innerHTML = naicsHtml;
        
        // Recent contracts table
        const contractsHtml = (data.recent_contracts || []).map(c => `
            <tr>
                <td class="small">${c.agency || 'N/A'}</td>
                <td class="small">${c.description ? c.description.substring(0, 50) + '...' : 'N/A'}</td>
                <td class="small">${formatCurrency(c.value)}</td>
                <td class="small">${c.date_signed || 'N/A'}</td>
            </tr>
        `).join('') || '<tr><td colspan="4" class="text-center text-muted">No contracts found</td></tr>';
        document.getElementById('contractor-contracts-table').innerHTML = contractsHtml;
        
        // Set profile link
        document.getElementById('contractor-profile-link').href = `/competitive-intel/contractor/${encodeURIComponent(contractorName)}`;
        
    } catch (err) {
        document.getElementById('contractor-loading').style.display = 'none';
        document.getElementById('contractor-content').innerHTML = `
            <div class="alert alert-danger">Error loading contractor details: ${err.message}</div>
        `;
    }
}
</script>

<!-- Contractor Details Modal -->
<div class="modal fade" id="contractorModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background: #161B22; border: 1px solid #30363D;">
            <div class="modal-header" style="border-bottom: 1px solid #30363D;">
                <h5 class="modal-title">
                    <i class="fas fa-building me-2" style="color: #667eea;"></i>
                    <span id="contractor-modal-name"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Loading -->
                <div id="contractor-loading" class="text-center py-4">
                    <i class="fas fa-spinner fa-spin fa-2x mb-3" style="color: #00D4FF;"></i>
                    <p>Loading contractor details...</p>
                </div>
                
                <!-- Content -->
                <div id="contractor-content" style="display: none;">
                    <!-- Stats Row -->
                    <div class="row mb-4">
                        <div class="col-3 text-center">
                            <h3 id="contractor-total-contracts" style="color: #667eea;">0</h3>
                            <small class="text-muted">Contracts</small>
                        </div>
                        <div class="col-3 text-center">
                            <h3 id="contractor-total-value" style="color: #00C896;">$0</h3>
                            <small class="text-muted">Total Value</small>
                        </div>
                        <div class="col-3 text-center">
                            <h3 id="contractor-agencies-count" style="color: #FFB020;">0</h3>
                            <small class="text-muted">Agencies</small>
                        </div>
                        <div class="col-3 text-center">
                            <h3 id="contractor-naics-count" style="color: #00D4FF;">0</h3>
                            <small class="text-muted">NAICS Codes</small>
                        </div>
                    </div>
                    
                    <!-- Agencies -->
                    <div class="mb-4">
                        <h6><i class="fas fa-landmark me-2" style="color: #FFB020;"></i>Agencies</h6>
                        <div id="contractor-agencies"></div>
                    </div>
                    
                    <!-- NAICS Codes -->
                    <div class="mb-4">
                        <h6><i class="fas fa-code-branch me-2" style="color: #00D4FF;"></i>NAICS Codes</h6>
                        <div id="contractor-naics"></div>
                    </div>
                    
                    <!-- Recent Contracts -->
                    <div>
                        <h6><i class="fas fa-file-contract me-2" style="color: #667eea;"></i>Recent Contracts</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Agency</th>
                                        <th>Description</th>
                                        <th>Value</th>
                                        <th>Date</th>
                                    </tr>
                                </thead>
                                <tbody id="contractor-contracts-table">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid #30363D;">
                <a id="contractor-profile-link" href="#" class="btn btn-outline-primary">
                    <i class="fas fa-external-link-alt me-1"></i>View Full Profile
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<style>
.contractor-row, .contractor-cell {
    cursor: pointer;
    transition: all 0.2s ease;
}
.contractor-row:hover, .contractor-cell:hover {
    background-color: rgba(102, 126, 234, 0.15) !important;
}
.contractor-row:hover, .contractor-row:hover *, 
.contractor-cell:hover, .contractor-cell:hover * {
    color: #00D4FF !important;
}
.contractor-row:hover .text-muted,
.contractor-cell:hover .text-muted {
    color: #8B949E !important;
}
.org-research-btn {
    background: transparent;
    border: 1px solid #8B949E;
    color: #8B949E;
    padding: 2px 8px;
    transition: all 0.2s ease;
}
.org-research-btn:hover {
    background: #00C896;
    border-color: #00C896;
    color: white;
}
.org-research-btn.has-research {
    background: #00C896;
    border-color: #00C896;
    color: white;
}
/* Prevent accordion buttons from having hover issues */
.accordion-button:hover {
    background: var(--surface-light) !important;
    color: var(--text) !important;
}
.accordion-item:hover {
    background: var(--surface) !important;
}
</style>

<!-- Organization Research Modal -->
<div class="modal fade" id="orgResearchModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background: #161B22; border: 1px solid #30363D;">
            <div class="modal-header" style="border-bottom: 1px solid #30363D;">
                <h5 class="modal-title">
                    <i class="fas fa-brain me-2" style="color: #00C896;"></i>
                    Contractor Research: <span id="org-research-name"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Loading -->
                <div id="org-research-loading" class="text-center py-4">
                    <i class="fas fa-spinner fa-spin fa-2x mb-3" style="color: #00D4FF;"></i>
                    <p>Loading research profile...</p>
                </div>
                
                <!-- Empty State -->
                <div id="org-research-empty" style="display: none;" class="text-center py-4">
                    <i class="fas fa-building fa-3x mb-3" style="color: #8B949E;"></i>
                    <h5>No Research Data Yet</h5>
                    <p class="text-muted">Click below to research this contractor for teaming evaluation.</p>
                    <button id="run-org-research-btn" class="btn btn-success" onclick="runOrgResearch()">
                        <i class="fas fa-brain me-2"></i>Research Contractor
                    </button>
                    <p class="small text-muted mt-2">Estimated cost: ~$0.02 | Time: ~30 seconds</p>
                </div>
                
                <!-- Research Content -->
                <div id="org-research-content" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span>Confidence: <span id="org-research-confidence" class="badge bg-success">high</span></span>
                        <span class="text-muted small">Researched: <span id="org-research-date"></span></span>
                    </div>
                    
                    <div class="mb-4 p-3" style="background: #1F2937; border-radius: 8px;">
                        <h6><i class="fas fa-building me-2" style="color: #00D4FF;"></i>Company Overview</h6>
                        <p id="org-research-overview" class="mb-2"></p>
                        <div class="row small">
                            <div class="col-md-6">
                                <strong>Headquarters:</strong> <span id="org-research-hq"></span>
                            </div>
                            <div class="col-md-6">
                                <strong>Employees:</strong> <span id="org-research-employees"></span>
                            </div>
                        </div>
                        <div class="mt-2">
                            <strong>Website:</strong> <a id="org-research-website" href="#" target="_blank" style="color: #00D4FF;"></a>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <h6><i class="fas fa-certificate me-2" style="color: #FFB020;"></i>Certifications</h6>
                            <div id="org-research-certs"></div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <h6><i class="fas fa-cogs me-2" style="color: #00D4FF;"></i>Capabilities</h6>
                            <ul id="org-research-capabilities" class="small"></ul>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <h6><i class="fas fa-landmark me-2" style="color: #667eea;"></i>Key Agencies</h6>
                            <ul id="org-research-agencies" class="small"></ul>
                        </div>
                        <div class="col-md-6 mb-3">
                            <h6><i class="fas fa-users me-2" style="color: #9C27B0;"></i>Leadership</h6>
                            <ul id="org-research-leadership" class="small"></ul>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <h6><i class="fas fa-trophy me-2" style="color: #FFB020;"></i>Notable Contracts</h6>
                        <ul id="org-research-contracts" class="small"></ul>
                    </div>
                    
                    <div class="mb-3">
                        <h6><i class="fas fa-newspaper me-2" style="color: #8B949E;"></i>Recent News</h6>
                        <ul id="org-research-news" class="small"></ul>
                    </div>
                    
                    <div class="mb-3 p-3" style="background: rgba(0, 200, 150, 0.1); border-radius: 8px; border: 1px solid #00C896;">
                        <h6><i class="fas fa-handshake me-2" style="color: #00C896;"></i>Teaming Fit Assessment</h6>
                        <p id="org-research-teaming" class="mb-0 small"></p>
                    </div>
                    
                    <div class="mb-3">
                        <h6><i class="fas fa-link me-2" style="color: #8B949E;"></i>Sources</h6>
                        <ul id="org-research-sources" class="small"></ul>
                    </div>
                    
                    <div class="text-end">
                        <button class="btn btn-outline-success btn-sm" onclick="runOrgResearch(true)">
                            <i class="fas fa-sync me-2"></i>Refresh Research
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Organization Research Functions
let currentOrgName = '';

async function viewOrgResearch(orgName) {
    currentOrgName = orgName;
    const modal = new bootstrap.Modal(document.getElementById('orgResearchModal'));
    document.getElementById('org-research-name').textContent = orgName;
    document.getElementById('org-research-loading').style.display = 'block';
    document.getElementById('org-research-content').style.display = 'none';
    document.getElementById('org-research-empty').style.display = 'none';
    
    modal.show();
    
    try {
        const res = await fetch(`/api/competitive/organization/${encodeURIComponent(orgName)}/research`);
        const data = await res.json();
        
        document.getElementById('org-research-loading').style.display = 'none';
        
        if (data.research_profile) {
            displayOrgResearch(data.research_profile);
        } else {
            document.getElementById('org-research-empty').style.display = 'block';
        }
    } catch (error) {
        document.getElementById('org-research-loading').style.display = 'none';
        document.getElementById('org-research-empty').style.display = 'block';
        console.error('Error loading org research:', error);
    }
}

function displayOrgResearch(profile) {
    document.getElementById('org-research-content').style.display = 'block';
    
    // Confidence badge
    const conf = profile.confidence || 'low';
    document.getElementById('org-research-confidence').textContent = conf;
    document.getElementById('org-research-confidence').className = 
        `badge bg-${conf === 'high' ? 'success' : conf === 'medium' ? 'warning' : 'secondary'}`;
    
    // Date
    document.getElementById('org-research-date').textContent = profile.researched_at ? 
        new Date(profile.researched_at).toLocaleDateString() : 'Unknown';
    
    // Overview
    document.getElementById('org-research-overview').textContent = profile.company_overview || 'No overview available';
    document.getElementById('org-research-hq').textContent = profile.headquarters || 'Unknown';
    document.getElementById('org-research-employees').textContent = profile.employee_count || 'Unknown';
    
    // Website
    const websiteEl = document.getElementById('org-research-website');
    if (profile.website) {
        websiteEl.href = profile.website.startsWith('http') ? profile.website : 'https://' + profile.website;
        websiteEl.textContent = profile.website;
        websiteEl.style.display = 'inline';
    } else {
        websiteEl.style.display = 'none';
    }
    
    // Certifications
    const certs = profile.certifications || [];
    document.getElementById('org-research-certs').innerHTML = certs.length ? 
        certs.map(c => `<span class="badge bg-warning text-dark me-1 mb-1">${c}</span>`).join('') :
        '<span class="text-muted">None found</span>';
    
    // Capabilities
    document.getElementById('org-research-capabilities').innerHTML = 
        (profile.capabilities || []).map(c => `<li>${c}</li>`).join('') || '<li class="text-muted">None found</li>';
    
    // Key Agencies
    document.getElementById('org-research-agencies').innerHTML = 
        (profile.key_agencies || []).map(a => `<li>${a}</li>`).join('') || '<li class="text-muted">None found</li>';
    
    // Leadership
    document.getElementById('org-research-leadership').innerHTML = 
        (profile.leadership || []).map(l => `<li>${l}</li>`).join('') || '<li class="text-muted">None found</li>';
    
    // Notable Contracts
    document.getElementById('org-research-contracts').innerHTML = 
        (profile.notable_contracts || []).map(c => `<li>${c}</li>`).join('') || '<li class="text-muted">None found</li>';
    
    // Recent News
    document.getElementById('org-research-news').innerHTML = 
        (profile.recent_news || []).map(n => `<li>${n}</li>`).join('') || '<li class="text-muted">None found</li>';
    
    // Teaming Fit
    document.getElementById('org-research-teaming').textContent = profile.teaming_fit || 'No assessment available';
    
    // Sources
    document.getElementById('org-research-sources').innerHTML = 
        (profile.sources || []).map(s => `<li><a href="${s}" target="_blank" style="color: #00D4FF;">${s.substring(0, 60)}...</a></li>`).join('') || 
        '<li class="text-muted">No sources</li>';
}

async function runOrgResearch(forceRefresh = false) {
    const btn = document.getElementById('run-org-research-btn');
    if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Researching...';
    }
    
    document.getElementById('org-research-loading').style.display = 'block';
    document.getElementById('org-research-empty').style.display = 'none';
    document.getElementById('org-research-content').style.display = 'none';
    
    try {
        const res = await fetch('/api/competitive/organization/research', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ name: currentOrgName, force_refresh: forceRefresh })
        });
        
        const data = await res.json();
        
        document.getElementById('org-research-loading').style.display = 'none';
        
        if (data.status === 'success' && data.research_profile) {
            displayOrgResearch(data.research_profile);
        } else {
            alert('Research error: ' + (data.error || 'Unknown error'));
            document.getElementById('org-research-empty').style.display = 'block';
        }
    } catch (error) {
        document.getElementById('org-research-loading').style.display = 'none';
        document.getElementById('org-research-empty').style.display = 'block';
        alert('Error: ' + error.message);
    } finally {
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-brain me-2"></i>Research Contractor';
        }
    }
}
</script>
{% endblock %}
