{% extends "base-ultimate.html" %}

{% block title %}Admin Panel - BD Intelligence{% endblock %}
{% block page_title %}System Administration{% endblock %}
{% block page_subtitle %}Configure system settings, agents, and data management{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <h6 class="mb-3">Settings Menu</h6>
                <nav class="nav flex-column">
                    <a class="nav-link active" data-tab="system" onclick="switchTab('system')">
                        <i class="fas fa-cog me-2"></i>System Settings
                    </a>
                    <a class="nav-link" data-tab="filters" onclick="switchTab('filters')">
                        <i class="fas fa-filter me-2"></i>Collection Filters
                    </a>
                    <a class="nav-link" data-tab="agents" onclick="switchTab('agents')">
                        <i class="fas fa-robot me-2"></i>AI Agents
                    </a>
                    <a class="nav-link" data-tab="company" onclick="switchTab('company')">
                        <i class="fas fa-building me-2"></i>Company Info
                    </a>
                    <a class="nav-link" data-tab="experience" onclick="switchTab('experience')">
                        <i class="fas fa-file-alt me-2"></i>Experience Docs
                    </a>
                    <a class="nav-link" data-tab="data" onclick="switchTab('data')">
                        <i class="fas fa-database me-2"></i>Data Management
                    </a>
                </nav>
            </div>
        </div>
    </div>
    
    <div class="col-md-9">
        <!-- System Settings Tab -->
        <div class="tab-content active" id="tab-system">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-cog me-2"></i>System Settings</h5>
                </div>
                <div class="card-body">
                    <h6 class="mb-3">API Keys</h6>
                    
                    <div class="mb-3">
                        <label class="form-label">SAM.gov API Key</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="sam-api-key" 
                                   placeholder="Enter your SAM.gov API key">
                            <button class="btn btn-outline-secondary" type="button" onclick="toggleVisibility('sam-api-key')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <small class="text-muted">Get your API key at <a href="https://sam.gov/data-services" target="_blank">sam.gov/data-services</a></small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Anthropic Claude API Key</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="anthropic-api-key" 
                                   placeholder="Enter your Anthropic API key">
                            <button class="btn btn-outline-secondary" type="button" onclick="toggleVisibility('anthropic-api-key')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <small class="text-muted">Get your API key at <a href="https://console.anthropic.com" target="_blank">console.anthropic.com</a></small>
                    </div>
                    
                    <hr>
                    
                    <button class="btn btn-success" onclick="saveSystemSettings()">
                        <i class="fas fa-save me-2"></i>Save Settings
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Collection Filters Tab -->
        <div class="tab-content" id="tab-filters" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Collection Filters</h5>
                </div>
                <div class="card-body">
                    <h6 class="mb-3">NAICS Codes (IT Only)</h6>
                    <div class="mb-3">
                        <textarea class="form-control" id="naics-codes" rows="3">541511,541512,541519,518210</textarea>
                        <small class="text-muted">
                            541511=Custom Programming, 541512=Systems Design, 541519=Other IT, 518210=Data Processing
                        </small>
                    </div>
                    
                    <hr>
                    
                    <h6 class="mb-3">PSC Codes</h6>
                    <div class="mb-3">
                        <textarea class="form-control" id="psc-codes" rows="3">D302,D307,D310,D311,D312,D314,D316,D317,D318,D320,D321,7030</textarea>
                        <small class="text-muted">D3xx series = IT & Telecom, 7030 = ADP Equipment</small>
                    </div>
                    
                    <hr>
                    
                    <h6 class="mb-3">IT Keywords (Include)</h6>
                    <div class="mb-3">
                        <textarea class="form-control" id="it-keywords" rows="4">software,cloud,cybersecurity,network,database,application,development,programming,devops,agile,AI,machine learning,analytics</textarea>
                        <small class="text-muted">Comma-separated list of keywords to include</small>
                    </div>
                    
                    <hr>
                    
                    <h6 class="mb-3">Exclusion Keywords (Reject)</h6>
                    <div class="mb-3">
                        <textarea class="form-control" id="exclusion-keywords" rows="4">janitorial,custodial,cleaning,landscaping,construction,renovation,hvac,plumbing,facilities maintenance,security guard</textarea>
                        <small class="text-muted">Comma-separated list of keywords to exclude</small>
                    </div>
                    
                    <hr>
                    
                    <h6 class="mb-3">Collection Settings</h6>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Days Back to Search</label>
                            <input type="number" class="form-control" id="days-back" value="30" min="1" max="365">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Default Limit</label>
                            <input type="number" class="form-control" id="default-limit" value="25" min="1" max="1000">
                        </div>
                    </div>
                    
                    <button class="btn btn-success" onclick="saveFilterSettings()">
                        <i class="fas fa-save me-2"></i>Save Filter Settings
                    </button>
                </div>
            </div>
        </div>
        
        <!-- AI Agents Tab -->
        <div class="tab-content" id="tab-agents" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-robot me-2"></i>AI Agent Configuration</h5>
                </div>
                <div class="card-body">
                    <h6 class="mb-3">Agent Status</h6>
                    
                    <div class="list-group mb-4">
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">Agent 1: Opportunity Scout</h6>
                                    <small class="text-muted">Monitors SAM.gov and scores opportunities</small>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="agent1-enabled" checked>
                                </div>
                            </div>
                        </div>
                        
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">Agent 2: Competitive Intelligence</h6>
                                    <small class="text-muted">Analyzes incumbents and identifies teaming partners</small>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="agent2-enabled" checked>
                                </div>
                            </div>
                        </div>
                        
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">Agent 3: Capability Matching</h6>
                                    <small class="text-muted">Matches staff to opportunity requirements</small>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="agent3-enabled" checked>
                                </div>
                            </div>
                        </div>
                        
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">Agent 4: RFI Generator</h6>
                                    <small class="text-muted">Auto-generates RFI responses with Claude AI</small>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="agent4-enabled" checked>
                                </div>
                            </div>
                        </div>
                        
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">Agent 5: Proposal Writer</h6>
                                    <small class="text-muted">Drafts proposals with Claude AI</small>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="agent5-enabled" checked>
                                </div>
                            </div>
                        </div>
                        
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">Agent 6: Pricing Generator</h6>
                                    <small class="text-muted">Calculates pricing and generates IGCEs</small>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="agent6-enabled" checked>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <h6 class="mb-3">Pricing Configuration</h6>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Fringe Rate (%)</label>
                            <input type="number" class="form-control" id="fringe-rate" value="30" step="0.1">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Overhead Rate (%)</label>
                            <input type="number" class="form-control" id="overhead-rate" value="45" step="0.1">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">G&A Rate (%)</label>
                            <input type="number" class="form-control" id="ga-rate" value="8" step="0.1">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Profit/Fee (%)</label>
                            <input type="number" class="form-control" id="profit-rate" value="10" step="0.1">
                        </div>
                    </div>
                    
                    <button class="btn btn-success" onclick="saveAgentSettings()">
                        <i class="fas fa-save me-2"></i>Save Agent Settings
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Company Info Tab -->
        <div class="tab-content" id="tab-company" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-building me-2"></i>Company Information</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">This information is used in RFI responses and proposals.</p>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Company Name</label>
                            <input type="text" class="form-control" id="company-name" placeholder="Your Company Name">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">DUNS Number</label>
                            <input type="text" class="form-control" id="company-duns" placeholder="123456789">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">CAGE Code</label>
                            <input type="text" class="form-control" id="company-cage" placeholder="1A2B3">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Company Status</label>
                            <select class="form-select" id="company-status">
                                <option>Small Business</option>
                                <option>Small Disadvantaged Business</option>
                                <option>Woman-Owned Small Business</option>
                                <option>Veteran-Owned Small Business</option>
                                <option>HUBZone</option>
                                <option>8(a)</option>
                                <option>Large Business</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Core Capabilities (comma-separated)</label>
                        <textarea class="form-control" id="company-capabilities" rows="3" placeholder="Cloud Computing, Cybersecurity, Software Development, AI/ML, IT Modernization"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Certifications (comma-separated)</label>
                        <input type="text" class="form-control" id="company-certifications" placeholder="ISO 9001, ISO 27001, CMMI Level 3">
                    </div>
                    
                    <button class="btn btn-success" onclick="saveCompanyInfo()">
                        <i class="fas fa-save me-2"></i>Save Company Info
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Experience Documents Tab -->
        <div class="tab-content" id="tab-experience" style="display: none;">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i>Company Experience Documents</h5>
                    <label class="btn btn-success mb-0">
                        <i class="fas fa-upload me-2"></i>Upload Document
                        <input type="file" accept=".txt,.docx" style="display: none;" onchange="uploadCompanyDoc(this)">
                    </label>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">
                        Upload <code>.txt</code> or <code>.docx</code> files describing your company's experience.
                        The RFI Generator will automatically search these documents for relevant content when generating responses.
                    </p>

                    <div id="docs-list">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary"></div>
                            <p class="text-muted mt-2">Loading documents...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Management Tab -->
        <div class="tab-content" id="tab-data" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-database me-2"></i>Data Management</h5>
                </div>
                <div class="card-body">
                    <h6 class="mb-3">Data Operations</h6>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6><i class="fas fa-sync me-2"></i>Sync Contacts</h6>
                                    <p class="small text-muted mb-3">Import all contacts from graph database</p>
                                    <button class="btn btn-primary w-100" onclick="syncContactsFromNeo4j()">
                                        Sync Contacts
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6><i class="fas fa-calculator me-2"></i>Re-score Opportunities</h6>
                                    <p class="small text-muted mb-3">Recalculate scores for all opportunities</p>
                                    <button class="btn btn-info w-100" onclick="rescoreOpportunities()">
                                        Re-score All
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6><i class="fas fa-file-excel me-2"></i>Export to Excel</h6>
                                    <p class="small text-muted mb-3">Export all data to Excel workbook</p>
                                    <button class="btn btn-success w-100" onclick="exportToExcel()">
                                        Export Data
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6><i class="fas fa-trash me-2"></i>Clear Cache</h6>
                                    <p class="small text-muted mb-3">Clear all cached data and temp files</p>
                                    <button class="btn btn-warning w-100" onclick="clearCache()">
                                        Clear Cache
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <h6 class="mb-3 text-danger">Danger Zone</h6>
                    <div class="card border-danger">
                        <div class="card-body">
                            <h6 class="text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Reset All Data</h6>
                            <p class="small text-muted mb-3">This will delete all opportunities, contacts, and configuration. This cannot be undone!</p>
                            <button class="btn btn-danger" onclick="resetAllData()">
                                <i class="fas fa-exclamation-triangle me-2"></i>Reset Everything
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Tab switching
function switchTab(tab) {
    document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
    document.querySelectorAll('[data-tab]').forEach(el => el.classList.remove('active'));
    
    document.getElementById(`tab-${tab}`).style.display = 'block';
    document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
}

// Toggle password visibility
function toggleVisibility(inputId) {
    const input = document.getElementById(inputId);
    input.type = input.type === 'password' ? 'text' : 'password';
}

// Save functions
function saveSystemSettings() {
    const settings = {
        samApiKey: document.getElementById('sam-api-key').value,
        anthropicApiKey: document.getElementById('anthropic-api-key').value
    };
    
    localStorage.setItem('system-settings', JSON.stringify(settings));
    
    alert('✓ System settings saved!\n\nRestart the dashboard to apply changes.');
}

function saveFilterSettings() {
    const settings = {
        naicsCodes: document.getElementById('naics-codes').value,
        pscCodes: document.getElementById('psc-codes').value,
        itKeywords: document.getElementById('it-keywords').value,
        exclusionKeywords: document.getElementById('exclusion-keywords').value,
        daysBack: document.getElementById('days-back').value,
        defaultLimit: document.getElementById('default-limit').value
    };
    
    localStorage.setItem('filter-settings', JSON.stringify(settings));
    
    alert('✓ Filter settings saved!');
}

function saveAgentSettings() {
    const settings = {
        agent1: document.getElementById('agent1-enabled').checked,
        agent2: document.getElementById('agent2-enabled').checked,
        agent3: document.getElementById('agent3-enabled').checked,
        agent4: document.getElementById('agent4-enabled').checked,
        agent5: document.getElementById('agent5-enabled').checked,
        agent6: document.getElementById('agent6-enabled').checked,
        fringeRate: document.getElementById('fringe-rate').value,
        overheadRate: document.getElementById('overhead-rate').value,
        gaRate: document.getElementById('ga-rate').value,
        profitRate: document.getElementById('profit-rate').value
    };
    
    localStorage.setItem('agent-settings', JSON.stringify(settings));
    
    alert('✓ Agent settings saved!');
}

function saveCompanyInfo() {
    const info = {
        name: document.getElementById('company-name').value,
        duns: document.getElementById('company-duns').value,
        cage: document.getElementById('company-cage').value,
        status: document.getElementById('company-status').value,
        capabilities: document.getElementById('company-capabilities').value,
        certifications: document.getElementById('company-certifications').value
    };
    
    localStorage.setItem('company-info', JSON.stringify(info));
    
    alert('✓ Company information saved!');
}

// Data operations
async function syncContactsFromNeo4j() {
    if (!confirm('Sync contacts?\n\nThis will import all contacts from the graph database.')) return;
    
    try {
        const res = await fetch('/api/contacts/sync', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const data = await res.json();
        
        if (data.status === 'success') {
            alert(`✓ Contacts Synced!\n\nTotal: ${data.synced}\nCreated: ${data.created}\nUpdated: ${data.updated}`);
        } else {
            alert('Error: ' + (data.error || 'Sync failed'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function rescoreOpportunities() {
    if (!confirm('Re-score all opportunities?\n\nThis may take a few minutes.')) return;
    
    alert('Re-scoring opportunities...\n\nThis feature requires backend implementation.');
}

function clearCache() {
    if (!confirm('Clear all cached data?\n\nThis will remove temporary files and force re-fetch on next load.')) return;
    
    localStorage.removeItem('kanban-state');
    
    alert('✓ Cache cleared!');
}

function resetAllData() {
    if (!confirm('⚠️ WARNING: This will delete ALL data!\n\nThis cannot be undone. Are you absolutely sure?')) return;
    if (!confirm('This is your last chance. Really delete everything?')) return;
    
    localStorage.clear();
    alert('✓ All data has been reset.\n\nRefresh the page to restart.');
    setTimeout(() => window.location.reload(), 2000);
}

// === Company Experience Documents ===
async function loadCompanyDocs() {
    try {
        const res = await fetch('/api/company-docs');
        const data = await res.json();
        const container = document.getElementById('docs-list');

        if (!data.documents || data.documents.length === 0) {
            container.innerHTML = `
                <div class="text-center py-4 text-muted">
                    <i class="fas fa-folder-open fa-3x mb-3"></i>
                    <p>No experience documents yet.</p>
                    <p class="small">Upload .txt or .docx files describing your company's experience.</p>
                </div>`;
            return;
        }

        container.innerHTML = `
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Filename</th>
                            <th>Size</th>
                            <th>Last Modified</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.documents.map(doc => `
                            <tr>
                                <td>
                                    <i class="fas fa-file-${doc.filename.endsWith('.docx') ? 'word text-primary' : 'alt text-info'} me-2"></i>
                                    ${doc.filename}
                                </td>
                                <td>${doc.size_display}</td>
                                <td>${new Date(doc.modified).toLocaleDateString()}</td>
                                <td class="text-end">
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteCompanyDoc('${doc.filename}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
            <div class="mt-2 text-muted small">
                <i class="fas fa-info-circle me-1"></i>
                ${data.count} document${data.count !== 1 ? 's' : ''} available for RFI response generation
            </div>`;
    } catch (error) {
        document.getElementById('docs-list').innerHTML =
            `<div class="alert alert-danger">Error loading documents: ${error.message}</div>`;
    }
}

async function uploadCompanyDoc(input) {
    if (!input.files || !input.files[0]) return;

    const file = input.files[0];
    const formData = new FormData();
    formData.append('file', file);

    try {
        const res = await fetch('/api/company-docs/upload', {
            method: 'POST',
            body: formData
        });
        const data = await res.json();

        if (data.status === 'success') {
            loadCompanyDocs();
        } else {
            alert('Error: ' + (data.error || 'Upload failed'));
        }
    } catch (error) {
        alert('Error uploading: ' + error.message);
    }

    // Reset file input
    input.value = '';
}

async function deleteCompanyDoc(filename) {
    if (!confirm(`Delete "${filename}"?\n\nThis file will no longer be used for RFI responses.`)) return;

    try {
        const res = await fetch(`/api/company-docs/${encodeURIComponent(filename)}`, {
            method: 'DELETE'
        });
        const data = await res.json();

        if (data.status === 'success') {
            loadCompanyDocs();
        } else {
            alert('Error: ' + (data.error || 'Delete failed'));
        }
    } catch (error) {
        alert('Error deleting: ' + error.message);
    }
}

// Load saved settings on page load
document.addEventListener('DOMContentLoaded', () => {
    loadCompanyDocs();
    // Load system settings
    const systemSettings = localStorage.getItem('system-settings');
    if (systemSettings) {
        const settings = JSON.parse(systemSettings);
    }
    
    // Load company info
    const companyInfo = localStorage.getItem('company-info');
    if (companyInfo) {
        const info = JSON.parse(companyInfo);
        if (info.name) document.getElementById('company-name').value = info.name;
        if (info.duns) document.getElementById('company-duns').value = info.duns;
        if (info.cage) document.getElementById('company-cage').value = info.cage;
        if (info.status) document.getElementById('company-status').value = info.status;
        if (info.capabilities) document.getElementById('company-capabilities').value = info.capabilities;
        if (info.certifications) document.getElementById('company-certifications').value = info.certifications;
    }
});
</script>
{% endblock %}
