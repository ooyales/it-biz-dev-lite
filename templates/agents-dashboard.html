{% extends "base-ultimate.html" %}

{% block title %}Agent Dashboard - BD Intelligence{% endblock %}
{% block page_title %}AI Agent Dashboard{% endblock %}
{% block page_subtitle %}Monitor and control your 6 AI agents{% endblock %}

{% block stats_bar %}
<div class="stats-bar">
    <div class="stat-item">
        <div class="stat-icon purple">
            <i class="fas fa-robot"></i>
        </div>
        <div class="stat-info">
            <h4>6</h4>
            <p>Active Agents</p>
        </div>
    </div>
    
    <div class="stat-item">
        <div class="stat-icon green">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-info">
            <h4>42</h4>
            <p>Tasks Completed</p>
        </div>
    </div>
    
    <div class="stat-item">
        <div class="stat-icon blue">
            <i class="fas fa-clock"></i>
        </div>
        <div class="stat-info">
            <h4>2.3h</h4>
            <p>Time Saved Today</p>
        </div>
    </div>
    
    <div class="stat-item">
        <div class="stat-icon orange">
            <i class="fas fa-chart-line"></i>
        </div>
        <div class="stat-info">
            <h4>94%</h4>
            <p>Success Rate</p>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Agent Cards -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <h5 class="mb-0">
                    <i class="fas fa-search me-2"></i>Agent 1: Opportunity Scout
                </h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span class="badge bg-success">Active</span>
                    <span class="text-muted small">Last run: 2 hours ago</span>
                </div>
                <p class="small mb-3">Monitors SAM.gov for new opportunities and scores them based on your criteria.</p>
                <div class="progress mb-2" style="height: 8px;">
                    <div class="progress-bar bg-success" style="width: 100%"></div>
                </div>
                <p class="small text-muted mb-3">15 opportunities scored</p>
                <button class="btn btn-sm btn-outline-primary" onclick="viewAgentLogs(1, 'Opportunity Scout')">View Logs</button>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header" style="background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%); color: white;">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>Agent 2: Competitive Intelligence
                </h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span class="badge bg-success">Active</span>
                    <span class="text-muted small">Last run: 1 hour ago</span>
                </div>
                <p class="small mb-3">Analyzes incumbents and identifies potential teaming partners.</p>
                <div class="progress mb-2" style="height: 8px;">
                    <div class="progress-bar bg-success" style="width: 85%"></div>
                </div>
                <p class="small text-muted mb-3">12 analyses completed</p>
                <button class="btn btn-sm btn-outline-primary" onclick="viewAgentLogs(2, 'Competitive Intelligence')">View Logs</button>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header" style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: white;">
                <h5 class="mb-0">
                    <i class="fas fa-users me-2"></i>Agent 3: Capability Matching
                </h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span class="badge bg-success">Active</span>
                    <span class="text-muted small">Ready</span>
                </div>
                <p class="small mb-3">Matches staff capabilities to opportunity requirements.</p>
                <div class="progress mb-2" style="height: 8px;">
                    <div class="progress-bar bg-success" style="width: 90%"></div>
                </div>
                <p class="small text-muted mb-3">8 matches performed</p>
                <button class="btn btn-sm btn-outline-primary" onclick="viewAgentLogs(3, 'Capability Matching')">View Logs</button>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header" style="background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%); color: white;">
                <h5 class="mb-0">
                    <i class="fas fa-file-alt me-2"></i>Agent 4: RFI Generator
                </h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span class="badge bg-success">Active</span>
                    <span class="text-muted small">Ready</span>
                </div>
                <p class="small mb-3">Auto-generates professional RFI responses using Claude AI.</p>
                <div class="progress mb-2" style="height: 8px;">
                    <div class="progress-bar bg-success" style="width: 75%"></div>
                </div>
                <p class="small text-muted mb-3">3 RFIs generated</p>
                <button class="btn btn-sm btn-outline-primary" onclick="viewAgentLogs(4, 'RFI Generator')">View Logs</button>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header" style="background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%); color: white;">
                <h5 class="mb-0">
                    <i class="fas fa-file-word me-2"></i>Agent 5: Proposal Writer
                </h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span class="badge bg-success">Active</span>
                    <span class="text-muted small">Ready</span>
                </div>
                <p class="small mb-3">Drafts comprehensive proposals with Claude AI.</p>
                <div class="progress mb-2" style="height: 8px;">
                    <div class="progress-bar bg-success" style="width: 60%"></div>
                </div>
                <p class="small text-muted mb-3">2 proposals drafted</p>
                <button class="btn btn-sm btn-outline-primary" onclick="viewAgentLogs(5, 'Proposal Writer')">View Logs</button>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header" style="background: linear-gradient(135deg, #9f7aea 0%, #805ad5 100%); color: white;">
                <h5 class="mb-0">
                    <i class="fas fa-dollar-sign me-2"></i>Agent 6: Pricing Generator
                </h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span class="badge bg-success">Active</span>
                    <span class="text-muted small">Ready</span>
                </div>
                <p class="small mb-3">Calculates pricing and generates IGCEs.</p>
                <div class="progress mb-2" style="height: 8px;">
                    <div class="progress-bar bg-success" style="width: 70%"></div>
                </div>
                <p class="small text-muted mb-3">4 pricing models created</p>
                <button class="btn btn-sm btn-outline-primary" onclick="viewAgentLogs(6, 'Pricing Generator')">View Logs</button>
            </div>
        </div>
    </div>
</div>

<!-- Agent Logs Modal -->
<div class="modal fade" id="agentLogsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-history me-2"></i><span id="logsAgentName">Agent</span> Activity Logs
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="logsLoading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3 text-muted">Loading agent logs...</p>
                </div>
                
                <div id="logsContent" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th style="width: 150px;">Timestamp</th>
                                    <th>Action</th>
                                    <th style="width: 100px;">Status</th>
                                    <th style="width: 100px;">Duration</th>
                                    <th style="width: 80px;">Details</th>
                                </tr>
                            </thead>
                            <tbody id="logsTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div id="logsEmpty" style="display: none;" class="text-center py-5">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No logs found for this agent yet.</p>
                </div>
                
                <div id="logsError" style="display: none;" class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span id="logsErrorMessage"></span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function viewAgentLogs(agentId, agentName) {
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('agentLogsModal'));
    modal.show();
    
    // Set agent name
    document.getElementById('logsAgentName').textContent = agentName;
    
    // Reset states
    document.getElementById('logsLoading').style.display = 'block';
    document.getElementById('logsContent').style.display = 'none';
    document.getElementById('logsEmpty').style.display = 'none';
    document.getElementById('logsError').style.display = 'none';
    
    try {
        // Fetch logs
        const response = await fetch(`/api/agents/logs?agent_id=${agentId}&limit=50`);
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || 'Failed to load logs');
        }
        
        // Hide loading
        document.getElementById('logsLoading').style.display = 'none';
        
        if (data.logs && data.logs.length > 0) {
            // Render logs
            renderLogs(data.logs);
            document.getElementById('logsContent').style.display = 'block';
        } else {
            // No logs
            document.getElementById('logsEmpty').style.display = 'block';
        }
        
    } catch (error) {
        document.getElementById('logsLoading').style.display = 'none';
        document.getElementById('logsError').style.display = 'block';
        document.getElementById('logsErrorMessage').textContent = error.message;
    }
}

function renderLogs(logs) {
    const tbody = document.getElementById('logsTableBody');
    tbody.innerHTML = '';
    
    logs.forEach(log => {
        const row = document.createElement('tr');
        
        // Timestamp
        const timestamp = new Date(log.timestamp).toLocaleString();
        
        // Status badge
        let statusBadge = '';
        if (log.status === 'success') {
            statusBadge = '<span class="badge bg-success">Success</span>';
        } else if (log.status === 'error') {
            statusBadge = '<span class="badge bg-danger">Error</span>';
        } else {
            statusBadge = '<span class="badge bg-warning">Running</span>';
        }
        
        // Duration
        const duration = log.duration_seconds ? 
            `${log.duration_seconds.toFixed(2)}s` : 
            'N/A';
        
        // Details button
        const hasDetails = log.input_data || log.output_data || log.error_message;
        const detailsBtn = hasDetails ? 
            `<button class="btn btn-sm btn-outline-secondary" onclick='showLogDetails(${JSON.stringify(log).replace(/'/g, "\\'")})'><i class="fas fa-eye"></i></button>` :
            '-';
        
        row.innerHTML = `
            <td class="small">${timestamp}</td>
            <td>${log.action}</td>
            <td>${statusBadge}</td>
            <td>${duration}</td>
            <td>${detailsBtn}</td>
        `;
        
        tbody.appendChild(row);
    });
}

function showLogDetails(log) {
    let details = '<div class="small">';
    
    if (log.input_data) {
        details += '<h6>Input:</h6><pre>' + JSON.stringify(log.input_data, null, 2) + '</pre>';
    }
    
    if (log.output_data) {
        details += '<h6>Output:</h6><pre>' + JSON.stringify(log.output_data, null, 2) + '</pre>';
    }
    
    if (log.error_message) {
        details += '<h6>Error:</h6><div class="alert alert-danger">' + log.error_message + '</div>';
    }
    
    details += '</div>';
    
    // Show in a simple alert (could be enhanced with a nested modal)
    const detailsModal = document.createElement('div');
    detailsModal.innerHTML = `
        <div class="modal fade show" style="display: block; background: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Log Details</h5>
                        <button type="button" class="btn-close" onclick="this.closest('.modal').remove()"></button>
                    </div>
                    <div class="modal-body">
                        ${details}
                    </div>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(detailsModal);
}
</script>
{% endblock %}
