{% extends "base-ultimate.html" %}

{% block title %}Agent Dashboard - BD Intelligence{% endblock %}
{% block page_title %}AI Agent Dashboard{% endblock %}
{% block page_subtitle %}Monitor and control your AI agents{% endblock %}

{% block stats_bar %}
<div class="stats-bar">
    <div class="stat-item">
        <div class="stat-icon purple">
            <i class="fas fa-robot"></i>
        </div>
        <div class="stat-info">
            <h4 id="stat-agents">7</h4>
            <p>Agents</p>
        </div>
    </div>

    <div class="stat-item">
        <div class="stat-icon green">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-info">
            <h4 id="stat-runs">-</h4>
            <p>Total Runs</p>
        </div>
    </div>

    <div class="stat-item">
        <div class="stat-icon blue">
            <i class="fas fa-trophy"></i>
        </div>
        <div class="stat-info">
            <h4 id="stat-successes">-</h4>
            <p>Successes</p>
        </div>
    </div>

    <div class="stat-item">
        <div class="stat-icon orange">
            <i class="fas fa-chart-line"></i>
        </div>
        <div class="stat-info">
            <h4 id="stat-rate">-</h4>
            <p>Success Rate</p>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="row" id="agent-cards">
    <!-- Cards rendered by JS -->
</div>

<!-- Agent Logs Modal -->
<div class="modal fade" id="agentLogsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-history me-2"></i><span id="logsAgentName">Agent</span> Activity Logs
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="logsLoading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3 text-muted">Loading agent logs...</p>
                </div>

                <div id="logsContent" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th style="width: 150px;">Timestamp</th>
                                    <th>Action</th>
                                    <th style="width: 100px;">Status</th>
                                    <th style="width: 100px;">Duration</th>
                                    <th style="width: 80px;">Details</th>
                                </tr>
                            </thead>
                            <tbody id="logsTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="logsEmpty" style="display: none;" class="text-center py-5">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No logs found for this agent yet.</p>
                </div>

                <div id="logsError" style="display: none;" class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span id="logsErrorMessage"></span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const AGENTS = [
    {id: 1, name: 'Opportunity Scout',        icon: 'fa-search',      gradient: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', desc: 'Monitors SAM.gov for new opportunities and scores them based on your criteria.'},
    {id: 2, name: 'Competitive Intelligence',  icon: 'fa-chart-bar',   gradient: 'linear-gradient(135deg, #4299e1 0%, #3182ce 100%)', desc: 'Analyzes incumbents and identifies potential teaming partners via USAspending.gov.'},
    {id: 3, name: 'Capability Matching',       icon: 'fa-users',       gradient: 'linear-gradient(135deg, #48bb78 0%, #38a169 100%)', desc: 'Matches staff capabilities to opportunity requirements.'},
    {id: 4, name: 'RFI Generator',             icon: 'fa-file-alt',    gradient: 'linear-gradient(135deg, #ed8936 0%, #dd6b20 100%)', desc: 'Auto-generates professional RFI responses using Claude AI.'},
    {id: 5, name: 'Proposal Writer',           icon: 'fa-file-word',   gradient: 'linear-gradient(135deg, #f56565 0%, #e53e3e 100%)', desc: 'Drafts comprehensive proposals with Claude AI.'},
    {id: 6, name: 'Pricing Generator',         icon: 'fa-dollar-sign', gradient: 'linear-gradient(135deg, #9f7aea 0%, #805ad5 100%)', desc: 'Calculates pricing and generates IGCEs.'},
    {id: 7, name: 'Contact Research',          icon: 'fa-brain',       gradient: 'linear-gradient(135deg, #38b2ac 0%, #319795 100%)', desc: 'Researches contacts\' public professional presence via web search.'},
];

function timeAgo(dateStr) {
    if (!dateStr) return 'Never';
    const diff = Date.now() - new Date(dateStr + 'Z').getTime();
    const mins = Math.floor(diff / 60000);
    if (mins < 1) return 'Just now';
    if (mins < 60) return `${mins}m ago`;
    const hrs = Math.floor(mins / 60);
    if (hrs < 24) return `${hrs}h ago`;
    const days = Math.floor(hrs / 24);
    return `${days}d ago`;
}

async function loadDashboard() {
    // Render cards immediately with placeholder stats
    const container = document.getElementById('agent-cards');
    container.innerHTML = AGENTS.map(a => `
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header" style="background: ${a.gradient}; color: white;">
                    <h5 class="mb-0">
                        <i class="fas ${a.icon} me-2"></i>Agent ${a.id}: ${a.name}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="badge bg-success">Active</span>
                        <span class="text-muted small" id="last-run-${a.id}">Loading...</span>
                    </div>
                    <p class="small mb-3">${a.desc}</p>
                    <div class="progress mb-2" style="height: 8px;">
                        <div class="progress-bar bg-success" id="progress-${a.id}" style="width: 0%"></div>
                    </div>
                    <p class="small text-muted mb-3" id="summary-${a.id}">Loading...</p>
                    <button class="btn btn-sm btn-outline-primary" onclick="viewAgentLogs(${a.id}, '${a.name}')">View Logs</button>
                </div>
            </div>
        </div>
    `).join('');

    // Fetch live stats
    try {
        const res = await fetch('/api/agents/stats/all?days=30');
        const data = await res.json();
        if (data.status !== 'success') return;

        // Update summary stats bar
        document.getElementById('stat-runs').textContent = data.totals.total_runs;
        document.getElementById('stat-successes').textContent = data.totals.successes;
        document.getElementById('stat-rate').textContent = data.totals.total_runs > 0 ? data.totals.success_rate + '%' : '-';

        // Update each agent card
        AGENTS.forEach(a => {
            const s = data.agents[a.id];
            if (!s) return;

            document.getElementById(`last-run-${a.id}`).textContent =
                s.last_run ? `Last run: ${timeAgo(s.last_run)}` : 'No runs yet';

            const rate = s.total_runs > 0 ? Math.round(s.success_rate) : 0;
            const bar = document.getElementById(`progress-${a.id}`);
            bar.style.width = (s.total_runs > 0 ? rate : 0) + '%';
            bar.className = `progress-bar ${rate >= 80 ? 'bg-success' : rate >= 50 ? 'bg-warning' : 'bg-danger'}`;

            document.getElementById(`summary-${a.id}`).textContent =
                s.total_runs > 0
                    ? `${s.total_runs} runs | ${s.successes} success | ${s.failures} errors | avg ${s.avg_duration.toFixed(1)}s`
                    : 'No activity yet';
        });

    } catch (err) {
        console.error('Failed to load agent stats:', err);
    }
}

async function viewAgentLogs(agentId, agentName) {
    const modal = new bootstrap.Modal(document.getElementById('agentLogsModal'));
    modal.show();

    document.getElementById('logsAgentName').textContent = agentName;

    document.getElementById('logsLoading').style.display = 'block';
    document.getElementById('logsContent').style.display = 'none';
    document.getElementById('logsEmpty').style.display = 'none';
    document.getElementById('logsError').style.display = 'none';

    try {
        const response = await fetch(`/api/agents/logs?agent_id=${agentId}&limit=50`);
        const data = await response.json();

        if (!response.ok) throw new Error(data.error || 'Failed to load logs');

        document.getElementById('logsLoading').style.display = 'none';

        if (data.logs && data.logs.length > 0) {
            renderLogs(data.logs);
            document.getElementById('logsContent').style.display = 'block';
        } else {
            document.getElementById('logsEmpty').style.display = 'block';
        }

    } catch (error) {
        document.getElementById('logsLoading').style.display = 'none';
        document.getElementById('logsError').style.display = 'block';
        document.getElementById('logsErrorMessage').textContent = error.message;
    }
}

function renderLogs(logs) {
    const tbody = document.getElementById('logsTableBody');
    tbody.innerHTML = '';

    logs.forEach(log => {
        const row = document.createElement('tr');

        const timestamp = new Date(log.timestamp + 'Z').toLocaleString();

        let statusBadge = '';
        if (log.status === 'success') {
            statusBadge = '<span class="badge bg-success">Success</span>';
        } else if (log.status === 'error') {
            statusBadge = '<span class="badge bg-danger">Error</span>';
        } else {
            statusBadge = '<span class="badge bg-warning">Running</span>';
        }

        const duration = log.duration_seconds ?
            `${log.duration_seconds.toFixed(2)}s` :
            'N/A';

        const hasDetails = log.input_data || log.output_data || log.error_message;
        const detailsBtn = hasDetails ?
            `<button class="btn btn-sm btn-outline-secondary" onclick='showLogDetails(${JSON.stringify(log).replace(/'/g, "\\'")})'>
                <i class="fas fa-eye"></i>
            </button>` :
            '-';

        row.innerHTML = `
            <td class="small">${timestamp}</td>
            <td>${log.action}</td>
            <td>${statusBadge}</td>
            <td>${duration}</td>
            <td>${detailsBtn}</td>
        `;

        tbody.appendChild(row);
    });
}

function showLogDetails(log) {
    let details = '<div class="small">';

    if (log.input_data) {
        details += '<h6>Input:</h6><pre>' + JSON.stringify(log.input_data, null, 2) + '</pre>';
    }

    if (log.output_data) {
        details += '<h6>Output:</h6><pre>' + JSON.stringify(log.output_data, null, 2) + '</pre>';
    }

    if (log.error_message) {
        details += '<h6>Error:</h6><div class="alert alert-danger">' + log.error_message + '</div>';
    }

    details += '</div>';

    const detailsModal = document.createElement('div');
    detailsModal.innerHTML = `
        <div class="modal fade show" style="display: block; background: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Log Details</h5>
                        <button type="button" class="btn-close" onclick="this.closest('.modal').remove()"></button>
                    </div>
                    <div class="modal-body">
                        ${details}
                    </div>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(detailsModal);
}

document.addEventListener('DOMContentLoaded', loadDashboard);
</script>
{% endblock %}
